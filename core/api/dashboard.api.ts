import api from './axiosClient';
import { getCropSeasonsForCurrentUser } from './cropSeason.api';
import { getWarehouseInboundRequestsForCurrentUser } from './warehouseRequest.api';

// Helper function ƒë·ªÉ format th·ªùi gian
const formatTimeAgo = (dateString: string): string => {
  const timeDiff = Date.now() - new Date(dateString).getTime();
  const hours = Math.floor(timeDiff / (1000 * 60 * 60));
  const days = Math.floor(hours / 24);
  
  if (days > 0) {
    return `${days} ng√†y tr∆∞·ªõc`;
  } else if (hours > 0) {
    return `${hours} gi·ªù tr∆∞·ªõc`;
  } else {
    return 'V·ª´a xong';
  }
};

export interface MenuItem {
  id: string;
  title: string;
  subtitle: string;
  icon: string;
  color: string;
  route: string;
  roles: string[];
}

export interface DashboardStats {
  icon: string;
  number: string;
  label: string;
}

export interface ActivityItem {
  icon: string;
  title: string;
  time: string;
}

export interface DashboardData {
  menuItems: MenuItem[];
  stats: DashboardStats[];
  activities: ActivityItem[];
}

export const dashboardAPI = {
  // L·∫•y menu items v√† stats theo role - s·ª≠ d·ª•ng API c√≥ s·∫µn
  getDashboardData: async (role: string): Promise<DashboardData> => {
    try {
      // L·∫•y stats v√† activities th·ª±c t·∫ø t·ª´ API
      const [stats, activities] = await Promise.all([
        dashboardAPI.getStatsByRole(role),
        dashboardAPI.getActivitiesByRole(role)
      ]);
      
      return {
        menuItems: getFallbackDashboardData(role).menuItems,
        stats: stats,
        activities: activities,
      };
    } catch (error) {
      console.error('‚ùå Error getting dashboard data:', error);
      return getFallbackDashboardData(role);
    }
  },

  // L·∫•y ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y theo role
  getActivitiesByRole: async (role: string): Promise<ActivityItem[]> => {
    try {
      if (role === 'DeliveryStaff') {
        // L·∫•y ho·∫°t ƒë·ªông th·ª±c t·∫ø t·ª´ API delivery
        const { getMyShipments } = await import('./delivery.api');
        
        try {
          const shipments = await getMyShipments();
          const recentShipments = shipments
            .sort((a, b) => new Date(b.updatedAt).getTime() - new Date(a.updatedAt).getTime())
            .slice(0, 3);

          return recentShipments.map(shipment => {
            const timeDiff = Date.now() - new Date(shipment.updatedAt).getTime();
            const hours = Math.floor(timeDiff / (1000 * 60 * 60));
            const days = Math.floor(hours / 24);
            
            let timeText = '';
            if (days > 0) {
              timeText = `${days} ng√†y tr∆∞·ªõc`;
            } else if (hours > 0) {
              timeText = `${hours} gi·ªù tr∆∞·ªõc`;
            } else {
              timeText = 'V·ª´a xong';
            }

            return {
              icon: shipment.deliveryStatus === 'Delivered' ? '‚úÖ' : 
                    shipment.deliveryStatus === 'InTransit' ? 'üöö' : 'üì±',
              title: `C·∫≠p nh·∫≠t tr·∫°ng th√°i: ${shipment.shipmentCode}`,
              time: timeText
            };
          });
        } catch (error) {
          console.error('‚ùå Error getting delivery activities:', error);
          return getFallbackActivities(role);
        }
      } else if (role === 'Farmer') {
        // L·∫•y ho·∫°t ƒë·ªông th·ª±c t·∫ø t·ª´ API farmer
        try {
          const [cropSeasons, warehouseRequests] = await Promise.all([
            getCropSeasonsForCurrentUser().catch(() => []),
            getWarehouseInboundRequestsForCurrentUser().catch(() => [])
          ]);

          const allActivities = [
            ...cropSeasons.map(season => ({
              icon: 'üå±',
              title: `M√πa v·ª•: ${season.name || season.cropSeasonCode}`,
              time: formatTimeAgo(season.updatedAt || season.createdAt)
            })),
            ...warehouseRequests.map(request => ({
              icon: 'üì¶',
              title: `L√¥ h√†ng: ${request.batchName || request.requestCode}`,
              time: formatTimeAgo(request.updatedAt || request.createdAt)
            }))
          ];

          return allActivities
            .sort((a, b) => new Date(b.time).getTime() - new Date(a.time).getTime())
            .slice(0, 3);
        } catch (error) {
          console.error('‚ùå Error getting farmer activities:', error);
          return getFallbackActivities(role);
        }
      } else {
        // Manager/Staff - L·∫•y ho·∫°t ƒë·ªông t·ªïng h·ª£p
        try {
          const [cropSeasons, warehouseRequests] = await Promise.all([
            getCropSeasonsForCurrentUser().catch(() => []),
            getWarehouseInboundRequestsForCurrentUser().catch(() => [])
          ]);

          const allActivities = [
            ...cropSeasons.map(season => ({
              icon: 'üå±',
              title: `M√πa v·ª•: ${season.name || season.cropSeasonCode}`,
              time: formatTimeAgo(season.updatedAt || season.createdAt)
            })),
            ...warehouseRequests.map(request => ({
              icon: 'üì¶',
              title: `L√¥ h√†ng: ${request.batchName || request.requestCode}`,
              time: formatTimeAgo(request.updatedAt || request.createdAt)
            }))
          ];

          return allActivities
            .sort((a, b) => new Date(b.time).getTime() - new Date(a.time).getTime())
            .slice(0, 3);
        } catch (error) {
          console.error('‚ùå Error getting manager activities:', error);
          return getFallbackActivities(role);
        }
      }
    } catch (error) {
      console.error('‚ùå Error getting activities by role:', error);
      return getFallbackActivities(role);
    }
  },

  // L·∫•y stats theo role - s·ª≠ d·ª•ng API c√≥ s·∫µn
  getStatsByRole: async (role: string): Promise<DashboardStats[]> => {
    try {
      if (role === 'Farmer') {
        // S·ª≠ d·ª•ng API c√≥ s·∫µn ƒë·ªÉ l·∫•y stats th·ª±c t·∫ø
        const [cropSeasons, warehouseRequests] = await Promise.all([
          getCropSeasonsForCurrentUser().catch(() => []),
          getWarehouseInboundRequestsForCurrentUser().catch(() => [])
        ]);

        // T√≠nh ti·∫øn ƒë·ªô d·ª±a tr√™n s·ªë m√πa v·ª• ƒë√£ ho√†n th√†nh
        const completedSeasons = cropSeasons.filter(season => season.status === 'Completed');
        const progressPercentage = cropSeasons.length > 0 
          ? Math.round((completedSeasons.length / cropSeasons.length) * 100)
          : 0;

        return [
          { icon: 'üå±', number: cropSeasons.length.toString(), label: 'M√πa v·ª•' },
          { icon: 'üì¶', number: warehouseRequests.length.toString(), label: 'L√¥ h√†ng' },
          { icon: 'üìä', number: `${progressPercentage}%`, label: 'Ti·∫øn ƒë·ªô' },
        ];
      } else if (role === 'DeliveryStaff') {
        // L·∫•y stats th·ª±c t·∫ø t·ª´ API delivery
        const { getMyShipments, getDeliveryStatistics } = await import('./delivery.api');
        
        try {
          const [shipments, statistics] = await Promise.all([
            getMyShipments().catch(() => []),
            getDeliveryStatistics().catch(() => null)
          ]);

          const today = new Date();
          const todayDeliveries = shipments.filter(s => {
            const shippedDate = new Date(s.shippedAt);
            return shippedDate.toDateString() === today.toDateString();
          }).length;

          return [
            { icon: 'üöö', number: shipments.length.toString(), label: 'T·ªïng ƒë∆°n giao' },
            { icon: '‚úÖ', number: todayDeliveries.toString(), label: 'Giao h√¥m nay' },
            { icon: '‚è≥', number: (shipments.filter(s => s.deliveryStatus === 'InTransit').length).toString(), label: 'ƒêang giao' },
          ];
        } catch (error) {
          console.error('‚ùå Error getting delivery stats:', error);
          // Fallback n·∫øu API l·ªói
          return [
            { icon: 'üöö', number: '0', label: 'T·ªïng ƒë∆°n giao' },
            { icon: '‚úÖ', number: '0', label: 'Giao h√¥m nay' },
            { icon: '‚è≥', number: '0', label: 'ƒêang giao' },
          ];
        }
      } else {
        // Manager/Staff - L·∫•y stats t·ªïng h·ª£p
        try {
          const [cropSeasons, warehouseRequests, shipments] = await Promise.all([
            getCropSeasonsForCurrentUser().catch(() => []),
            getWarehouseInboundRequestsForCurrentUser().catch(() => []),
            // TODO: Th√™m API l·∫•y shipments cho Manager/Staff khi c√≥
            Promise.resolve([])
          ]);

          // T√≠nh ti·∫øn ƒë·ªô t·ªïng th·ªÉ
          const totalItems = cropSeasons.length + warehouseRequests.length;
          const completedItems = cropSeasons.filter(s => s.status === 'Completed').length + 
                               warehouseRequests.filter(r => r.status === 'COMPLETED').length;
          const progressPercentage = totalItems > 0 
            ? Math.round((completedItems / totalItems) * 100)
            : 0;

          return [
            { icon: 'üå±', number: cropSeasons.length.toString(), label: 'M√πa v·ª•' },
            { icon: 'üì¶', number: warehouseRequests.length.toString(), label: 'L√¥ h√†ng' },
            { icon: 'üìä', number: `${progressPercentage}%`, label: 'Ti·∫øn ƒë·ªô' },
          ];
        } catch (error) {
          console.error('‚ùå Error getting manager stats:', error);
          // Fallback n·∫øu API l·ªói
          return [
            { icon: 'üå±', number: '0', label: 'M√πa v·ª•' },
            { icon: 'üì¶', number: '0', label: 'L√¥ h√†ng' },
            { icon: 'üìä', number: '0%', label: 'Ti·∫øn ƒë·ªô' },
          ];
        }
      }
    } catch (error) {
      console.error('‚ùå Error getting stats by role:', error);
      return getFallbackStats(role);
    }
  },
};

// Fallback data khi API kh√¥ng kh·∫£ d·ª•ng
const getFallbackDashboardData = (role: string): DashboardData => {
  const baseMenuItems: MenuItem[] = [
    {
      id: 'cropseason',
      title: 'M√πa v·ª•',
      subtitle: 'Qu·∫£n l√Ω m√πa v·ª• c√† ph√™',
      icon: 'üå±',
      color: '#10B981',
      route: '/cropseason',
      roles: ['Farmer', 'Manager'],
    },
    {
      id: 'warehouse',
      title: 'Kho h√†ng',
      subtitle: 'Qu·∫£n l√Ω nh·∫≠p xu·∫•t kho',
      icon: 'üè≠',
      color: '#3B82F6',
      route: '/warehouse',
      roles: ['Farmer', 'Manager', 'Staff'],
    },
    {
      id: 'delivery',
      title: 'Giao h√†ng',
      subtitle: 'Qu·∫£n l√Ω ƒë∆°n h√†ng giao',
      icon: 'üöö',
      color: '#F59E0B',
      route: '/delivery',
      roles: ['DeliveryStaff', 'Manager'],
    },
    {
      id: 'orders',
      title: 'ƒê∆°n h√†ng',
      subtitle: 'Theo d√µi tr·∫°ng th√°i ƒë∆°n h√†ng',
      icon: 'üìã',
      color: '#8B5CF6',
      route: '/orders',
      roles: ['DeliveryStaff', 'Manager'],
    },

    {
      id: 'reports',
      title: 'B√°o c√°o',
      subtitle: 'Xem b√°o c√°o t·ªïng h·ª£p',
      icon: 'üìà',
      color: '#8B5CF6',
      route: '/reports',
      roles: ['Farmer', 'Manager', 'DeliveryStaff'],
    },

  ];

  const filteredMenuItems = baseMenuItems.filter(item =>
    item.roles.includes(role)
  );

  return {
    menuItems: filteredMenuItems,
    stats: getFallbackStats(role),
    activities: getFallbackActivities(role),
  };
};

const getFallbackStats = (role: string): DashboardStats[] => {
  if (role === 'DeliveryStaff') {
    return [
      { icon: 'üöö', number: '8', label: 'ƒê∆°n giao' },
      { icon: '‚úÖ', number: '5', label: 'ƒê√£ giao' },
      { icon: '‚è≥', number: '3', label: 'ƒêang giao' },
    ];
  } else if (role === 'Farmer') {
    return [
      { icon: 'üå±', number: '4', label: 'M√πa v·ª•' },
      { icon: 'üì¶', number: '12', label: 'L√¥ h√†ng' },
      { icon: 'üìä', number: '85%', label: 'Ti·∫øn ƒë·ªô' },
    ];
  } else {
    // Manager/Staff
    return [
      { icon: 'üå±', number: '15', label: 'M√πa v·ª•' },
      { icon: 'üì¶', number: '48', label: 'L√¥ h√†ng' },
      { icon: 'üìä', number: '92%', label: 'Ti·∫øn ƒë·ªô' },
    ];
  }
};

const getFallbackActivities = (role: string): ActivityItem[] => {
  if (role === 'DeliveryStaff') {
    return [
      { icon: 'üöö', title: 'ƒê∆°n h√†ng m·ªõi ƒë∆∞·ª£c giao', time: '2 gi·ªù tr∆∞·ªõc' },
      { icon: '‚úÖ', title: 'Giao h√†ng th√†nh c√¥ng', time: '5 gi·ªù tr∆∞·ªõc' },
      { icon: 'üì±', title: 'C·∫≠p nh·∫≠t tr·∫°ng th√°i giao h√†ng', time: '1 ng√†y tr∆∞·ªõc' },
    ];
  } else if (role === 'Farmer') {
    return [
      { icon: 'üå±', title: 'M√πa v·ª• m·ªõi ƒë∆∞·ª£c t·∫°o', time: '2 gi·ªù tr∆∞·ªõc' },
      { icon: 'üì¶', title: 'L√¥ h√†ng ƒë√£ ƒë∆∞·ª£c nh·∫≠p kho', time: '5 gi·ªù tr∆∞·ªõc' },
      { icon: 'üìä', title: 'C·∫≠p nh·∫≠t ti·∫øn ƒë·ªô s·∫£n xu·∫•t', time: '1 ng√†y tr∆∞·ªõc' },
    ];
  } else {
    // Manager/Staff
    return [
      { icon: 'üå±', title: 'M√πa v·ª• m·ªõi ƒë∆∞·ª£c t·∫°o', time: '2 gi·ªù tr∆∞·ªõc' },
      { icon: 'üì¶', title: 'L√¥ h√†ng ƒë√£ ƒë∆∞·ª£c nh·∫≠p kho', time: '5 gi·ªù tr∆∞·ªõc' },
      { icon: 'üöö', title: 'ƒê∆°n h√†ng giao m·ªõi', time: '1 ng√†y tr∆∞·ªõc' },
    ];
  }
};
